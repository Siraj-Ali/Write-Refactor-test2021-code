Write two functions (createOrUpdate and willExpireAt) at UserRepository.php and TeHelper.php
1) write and divide createOrUpdate function in pieces which make the code short and clean
2) write a function willExpireAt and use less code and will working same as your code

Refactored the code you menetioned
